# 司法调解实训机 — 网站上线部署手册（零基础版）

本手册面向无部署经验的用户，在**腾讯云 CentOS 7.6** 服务器上，将项目部署到 **/opt/mediation**，通过二级域名 **px.ibizsoft.cn** 访问。

---

## 部署总览

| 步骤 | 内容 | 预计时间 |
|------|------|----------|
| 0 | 确认/安装 Docker 与 Docker Compose | 约 5 分钟 |
| 1 | 把项目放到 /opt/mediation | 约 5 分钟 |
| 2 | 配置环境变量 .env | 约 3 分钟 |
| 3 | 用 Docker 构建并启动服务 | 约 10～15 分钟 |
| 4 | 配置 Nginx 反向代理（px.ibizsoft.cn） | 约 5 分钟 |
| 5 | 配置 DNS（若未配置） | 约 2 分钟 |
| 6 | 浏览器访问与登录验证 | 约 2 分钟 |

---

## 步骤 0：确认 Docker 与 Docker Compose 已安装

### 0.1 登录服务器

- 使用 SSH 工具（如 Xshell、FinalShell、或终端）连接服务器。
- 地址：`122.51.67.38`，用户名一般为 `root` 或你创建的普通用户。

### 0.2 检查 Docker

在终端执行：

```bash
docker --version
```

- **若显示版本号**（如 `Docker version 26.x.x`）：说明已安装，跳到 0.3。
- **若提示命令不存在**：需要先安装 Docker（CentOS 7 示例）：

```bash
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install -y docker-ce docker-ce-cli containerd.io
sudo systemctl start docker
sudo systemctl enable docker
```

### 0.3 检查 Docker Compose

执行：

```bash
docker compose version
```

- **若显示版本号**（如 `Docker Compose version v2.x.x`）：说明已安装。
- **若没有**：可安装插件  
  `sudo yum install -y docker-compose-plugin`  
  或使用旧版命令 `docker-compose`（本手册以 `docker compose` 为例，若你只有 `docker-compose`，把后文中的 `docker compose` 改成 `docker-compose` 即可）。

---

## 步骤 1：把项目放到 /opt/mediation

目标：让 **/opt/mediation** 目录里包含本项目的所有文件（如 `docker-compose.yml`、`Dockerfile`、`server`、`package.json` 等）。

### 方式 A：本机有 Git，服务器也能访问 Git（推荐）

在服务器上执行：

```bash
# 若 /opt/mediation 是空的，直接克隆到 /opt，会得到 /opt/mediation
sudo git clone <你的仓库地址> /opt/mediation

# 若 /opt/mediation 已存在且为空，可先删再克隆，或克隆到临时目录再移动
# 例如克隆到 /opt/mediation-tmp 再移动：
# sudo git clone <你的仓库地址> /opt/mediation-tmp
# sudo mv /opt/mediation-tmp/* /opt/mediation-tmp/.[!.]* /opt/mediation/ 2>/dev/null; sudo rmdir /opt/mediation-tmp
```

把 `<你的仓库地址>` 换成实际地址（如 `https://github.com/xxx/mediation.git`）。

### 方式 B：用压缩包上传

1. 在你**本地电脑**上，把项目打成 zip（不要包含 `node_modules`、`.git` 等大文件夹，可只打包源码和 Docker 相关文件）。
2. 用 SFTP、FTP 或服务器「文件管理器」上传到服务器，例如上传到 `/tmp/mediation.zip`。
3. 在服务器执行：

```bash
sudo unzip /tmp/mediation.zip -d /opt/mediation
# 若解压后多了一层目录（如 /opt/mediation/mediation/），可：
# sudo mv /opt/mediation/mediation/* /opt/mediation/mediation/.[!.]* /opt/mediation/ 2>/dev/null
# sudo rmdir /opt/mediation/mediation 2>/dev/null
```

### 1.1 确认目录结构

执行：

```bash
ls -la /opt/mediation
```

应能看到：`docker-compose.yml`、`docker-compose.prod.yml`、`docker-compose.port8080.yml`、`Dockerfile`、`nginx.conf`、`package.json`、`server` 目录等。缺少任一文件都可能导致后续构建失败，请补全后再继续。

---

## 步骤 2：配置环境变量 .env

所有敏感信息（数据库密码、JWT 密钥等）都放在 `.env` 里，**不要**把 `.env` 提交到 Git。

### 2.1 创建 .env

在服务器上执行：

```bash
cd /opt/mediation
sudo cp .env.example .env
sudo chown $(whoami):$(whoami) .env
```

（若没有 `.env.example`，可跳过 `cp`，直接新建 `.env`。）

### 2.2 编辑 .env

用你习惯的方式编辑 `/opt/mediation/.env`，例如：

```bash
nano /opt/mediation/.env
```

或使用服务器上的「文件管理器」打开 `/opt/mediation/.env` 进行编辑。

### 2.3 建议内容（生产环境务必改密码和密钥）

下面是一份**示例**，请按需修改并**保存**：

```env
# 数据库（Docker 里 PostgreSQL 用）
POSTGRES_USER=mediation
POSTGRES_PASSWORD=请改成你自己的强密码
POSTGRES_DB=mediation

# 大模型（可选：不填则评估相关功能可能不可用）
QWEN_API_KEY=
DEEPSEEK_API_KEY=

# 鉴权与默认管理员（生产必须改）
JWT_SECRET=请改成一串随机长字符串
ADMIN_DEFAULT_PASSWORD=请改成管理员初始密码
```

说明：

- **POSTGRES_PASSWORD**：数据库密码，建议 16 位以上随机字符。
- **JWT_SECRET**：任意长字符串（如 32 位随机字母数字），用于登录 Token 签名。
- **ADMIN_DEFAULT_PASSWORD**：**生产环境必填**。首次启动且数据库无用户时，会自动创建管理员 **admin@mediation.local**，密码即此值。上线后请务必在「用户中心」修改密码；未设置时生产环境将拒绝启动。
- **QWEN_API_KEY / DEEPSEEK_API_KEY**：**可留空**。大模型 API Key 在本项目中是在**前端**「配置密钥」里填写并保存到数据库的，上线后登录再配置即可，无需在 .env 里写。

保存后确认文件在项目根目录：

```bash
cat /opt/mediation/.env
```

（仅检查是否生效，不要在不安全环境泄露输出。）

---

## 步骤 3：用 Docker 构建并启动服务

在**项目根目录**执行以下命令，会构建镜像并以后台方式启动（数据库 + 后端 + 前端）。

### 3.1 进入项目目录

```bash
cd /opt/mediation
```

### 3.2 一键构建并启动（生产模式 + 端口 8080）

现在生产环境使用单一配置文件，更简单直观。复制下面整行命令执行：

```bash
docker compose -f docker-compose.prod-8080.yml up -d --build
```

含义简要说明：

- `docker-compose.yml`：基础服务（PostgreSQL、后端、前端）。
- `docker-compose.prod.yml`：生产模式（前端构建成静态文件 + Nginx，后端跑编译后的 Node）。
- `docker-compose.port8080.yml`：把前端 Nginx 映射到主机 **8080**，不占 80，方便和主站共存。
- `up -d`：后台运行。
- `--build`：每次都会按 Dockerfile 重新构建镜像（首次或代码更新后需要）。

### 3.3 首次运行会发生什么

- 会拉取/构建镜像，可能需要 **5～15 分钟**（视网络和 CPU 而定）。
- 若看到类似 `mediation-db ... done`、`mediation-backend ... done`、`mediation-frontend ... done`，表示启动成功。

### 3.4 检查容器是否在跑

```bash
docker compose -f docker-compose.prod-8080.yml ps
```

应看到 3 个服务均为 **Up**（或 **running**）：

- mediation-db（或 postgres）
- mediation-backend（或 backend）
- mediation-frontend（或 frontend）

### 3.5 若启动失败：看日志

```bash
# 后端日志（数据库连接、接口报错等）
docker compose -f docker-compose.prod-8080.yml logs --tail=100 backend

# 前端日志（Nginx 等）
docker compose -f docker-compose.prod-8080.yml logs --tail=100 frontend
```

根据报错信息排查（常见：数据库未就绪、.env 未生效、端口被占用等）。

### 3.6 本机先测 8080（可选）

在服务器上执行：

```bash
curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8080
```

若返回 **200**，说明应用在 8080 已正常响应，可继续配置 Nginx。

---

## 步骤 4：配置 Nginx 反向代理（px.ibizsoft.cn）

让外网通过 **px.ibizsoft.cn** 访问时，由 Nginx 把请求转到本机的 8080 端口。

### 4.1 确认 Nginx 安装与配置目录

- CentOS 7 上 Nginx 的站点配置通常在：**/etc/nginx/conf.d/**  
  主配置：`/etc/nginx/nginx.conf`（一般会 `include conf.d/*.conf`）。

执行：

```bash
ls /etc/nginx/conf.d/
```

若目录存在，就在此目录下新建站点配置。

### 4.2 新建 px.ibizsoft.cn 的配置文件

创建文件：**/etc/nginx/conf.d/px.ibizsoft.cn.conf**

- **用命令行**（需有权限）：

```bash
sudo tee /etc/nginx/conf.d/px.ibizsoft.cn.conf << 'EOF'
server {
    listen 80;
    server_name px.ibizsoft.cn;

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF
```

- **用文件管理器**：在 `/etc/nginx/conf.d/` 下新建文件，文件名：`px.ibizsoft.cn.conf`，内容与上面 `server { ... }` 一致（从 `server {` 到最后一个 `}`）。

### 4.3 检查配置并重载 Nginx

```bash
sudo nginx -t
```

若显示 `syntax is ok` 和 `test is successful`，再执行：

```bash
sudo nginx -s reload
```

若 `nginx -t` 报错，根据提示修改 `px.ibizsoft.cn.conf`（如括号、分号缺失等）。

---

## 步骤 5：配置 DNS（若尚未配置）

要让 **px.ibizsoft.cn** 解析到你的服务器。

- 若已在腾讯云（或域名服务商）为 **ibizsoft.cn** 配置了 **泛解析** `*.ibizsoft.cn` → `122.51.67.38`，则 **px** 已解析，可跳过本步。
- 若没有泛解析：在 DNS 里新增一条 **A 记录**：
  - 主机记录：**px**
  - 记录值：**122.51.67.38**
  - 保存后等待几分钟，在本地执行 `ping px.ibizsoft.cn` 应能看到 122.51.67.38。

---

## 步骤 6：浏览器访问与登录

### 6.1 打开网站

在浏览器地址栏输入：

```
http://px.ibizsoft.cn
```

应看到「司法调解实训机」登录页。

### 6.2 默认管理员登录

- **账号**：`admin@mediation.local`（固定，仅首次创建时使用）
- **密码**：你在 `.env` 里设置的 **ADMIN_DEFAULT_PASSWORD**。  
  **生产环境**下未设置该变量时服务不会创建默认管理员且会拒绝启动，避免弱密码暴露。

登录后**务必**：

- 在「用户中心」→「修改密码」将管理员密码改为强密码；
- 在管理后台按需添加员工/导师账号。

### 6.3 若打不开或报错

- **打不开页面**：检查 DNS 是否生效（ping px.ibizsoft.cn）、服务器防火墙是否放行 80、Nginx 是否 `reload`、Docker 三个容器是否都在运行。
- **502 Bad Gateway**：多为 8080 未响应，请执行步骤 3.6 的 curl 检查，并查看 `docker compose ... logs frontend`。
- **登录失败**：确认 `.env` 中 `JWT_SECRET`、`ADMIN_DEFAULT_PASSWORD` 已保存且容器已重启（可 `docker compose ... up -d` 再试）。

---

## 常用运维命令汇总

在 **/opt/mediation** 目录下执行（若在其他目录，请先 `cd /opt/mediation`）：

```bash
# 查看运行状态
docker compose -f docker-compose.prod-8080.yml ps

# 查看最近日志（后端）
docker compose -f docker-compose.prod-8080.yml logs --tail=100 backend

# 查看最近日志（前端）
docker compose -f docker-compose.prod-8080.yml logs --tail=100 frontend

# 停止所有服务（数据保留在 Docker 卷中）
docker compose -f docker-compose.prod-8080.yml down

# 再次启动（不重新构建）
docker compose -f docker-compose.prod-8080.yml up -d

# 代码或配置更新后，重新构建并启动
docker compose -f docker-compose.prod-8080.yml up -d --build
```

---

## 上线后必做：管理员账号安全

| 事项 | 说明 |
|------|------|
| **密码来源** | 默认管理员密码来自 `.env` 的 `ADMIN_DEFAULT_PASSWORD`，**不是**写死在代码里。生产环境未设置时会直接报错并拒绝启动。 |
| **首次登录后** | 用 admin@mediation.local 登录后，进入「用户中心」→「修改密码」，改为只有你知道的强密码。 |
| **不要泄露 .env** | `.env` 含数据库密码、JWT 密钥、管理员初始密码，不要提交到 Git，不要发给他人。 |

---

## 可选：配置 HTTPS（推荐上线后配置）

1. 确保 **http://px.ibizsoft.cn** 已能正常访问。
2. 安装 certbot（CentOS 7 示例）：

```bash
sudo yum install -y certbot python3-certbot-nginx
```

3. 申请证书并自动修改 Nginx 配置：

```bash
sudo certbot --nginx -d px.ibizsoft.cn
```

按提示输入邮箱、同意条款即可。完成后用 **https://px.ibizsoft.cn** 访问。

---

## 故障排查简表

| 现象 | 可能原因 | 建议操作 |
|------|----------|----------|
| `docker compose` 报错 | 未在 /opt/mediation 或文件不全 | `cd /opt/mediation`，检查 docker-compose*.yml 是否存在 |
| 容器起不来 | 端口占用、.env 错误、构建失败 | 看 `logs backend` / `logs frontend`，检查 8080、5432 是否被占 |
| 能 ping 通但浏览器打不开 | 防火墙未放行 80、Nginx 未生效 | 放行 80，执行 `nginx -t` 和 `nginx -s reload` |
| 502 Bad Gateway | 8080 无响应 | `curl http://127.0.0.1:8080`，并确认 frontend 容器 Up |
| 登录一直失败 | 默认管理员未创建或密码不对 | 查看 backend 日志是否有「已创建默认管理员」，确认 .env 中 ADMIN_DEFAULT_PASSWORD |

---

本手册覆盖从「服务器环境准备」到「浏览器访问与登录」的完整流程。若某一步报错，可把终端或 Nginx 的报错信息记下来，便于进一步排查。
