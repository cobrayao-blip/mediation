# 司法调解实训机 — 项目规划与技术栈

## 一、目标与范围

在现有「案例模拟 + 带教 + 评估 + 技巧手册」基础上，实现：

- **多模型可配置**：前端可配置调用千问（通义千问）、DeepSeek，不再依赖 Gemini
- **用户管理**：企业员工账号、角色、权限
- **管理后台**：案例列表、技巧手册的增删改查（CRUD）
- **整合此前优化**：API 安全、组件拆分、错误处理、长对话与体验等

---

## 二、功能模块规划

### 2.1 角色与权限

| 角色     | 权限说明 |
|----------|----------|
| **管理员** | 用户管理（增删改查、分配角色）、案例 CRUD、技巧手册 CRUD、大模型 API 配置（可选：仅管理员可见） |
| **员工/学员** | 案例大厅、实战模拟、结案评估、技巧手册查阅；仅能看自己的练习记录（可选） |

### 2.2 大模型 API 配置

- **位置**：设置页或管理后台中的「大模型配置」模块
- **能力**：
  - 选择提供商：**千问（通义千问）** / **DeepSeek**
  - 填写 API Base URL（可选，用于自建或代理）、API Key
  - 选择模型名称（如 qwen-plus、deepseek-chat 等，可预设下拉 + 自定义）
- **安全**：API Key 仅存后端，前端只保存「当前使用的提供商/模型名」；请求一律经**后端代理**转发，避免 Key 暴露。

### 2.3 用户管理（企业员工）

- **列表**：支持按姓名、部门、角色筛选；分页
- **新增/编辑**：姓名、部门、手机/邮箱、角色（管理员/员工）、账号状态（启用/停用）
- **密码**：初始密码由管理员设置或「重置密码」链接；可选后续支持自助改密、忘记密码
- **可选**：与组织架构联动（部门树）、批量导入

### 2.4 案例管理（管理后台）

- **列表**：标题、分类、难度、争议焦点摘要、排序、启用/停用
- **新增/编辑**：标题、分类、难度、描述、争议焦点、当事人 A/B（姓名、特质、背景）
- **删除**：软删除或硬删除（建议软删除便于恢复）

### 2.5 技巧手册管理（管理后台）

- **列表**：技巧名称、分类、启用状态
- **新增/编辑**：名称、分类、描述、使用要点、推荐话术（多条）、常见误区（多条）
- **与现有结构一致**：保持前端使用的 `MediationSkill` 结构，便于接口统一

### 2.6 此前优化项整合

- **API 安全**：所有大模型请求走后端代理，Key 存服务端
- **前端组件拆分**：HomeScreen、SimulationChat、HandbookOverlay、AssessmentModal、MoodBar 等
- **错误与加载**：统一错误提示（toast/内联），评估失败不用 alert
- **长对话**：后端或前端对历史做截断/摘要，控制 token
- **README / 文档**：项目专属说明、环境变量、部署步骤
- **无障碍**：关键按钮 aria-label、评估弹窗 role="dialog"

---

## 三、技术栈建议

### 3.1 整体架构

```
[ 浏览器 ]
    ↓
[ 前端 SPA ]  ←→  [ 后端 API ]  ←→  [ 数据库 ]
    ↓                    ↓
  设置：模型选择      代理 → 千问 / DeepSeek API
  用户登录态         用户/案例/技巧 CRUD
```

- 前端与后端分离；后端统一代理大模型、做鉴权与业务逻辑。
- 大模型调用：仅后端持有 Key，前端只传「提供商 + 模型名 + 消息内容」。

### 3.2 前端

| 类别     | 建议技术 | 说明 |
|----------|----------|------|
| 框架     | **React 18/19 + TypeScript** | 保持现有，稳定 |
| 构建     | **Vite 6** | 保持 |
| 路由     | **React Router v6** | 区分：登录页、实训大厅、模拟页、设置页、管理后台（用户/案例/技巧/模型配置） |
| 状态     | **React Context + useReducer** 或 **Zustand** | 用户信息、Token、当前选的模型；管理后台列表用服务端状态即可 |
| 请求     | **fetch + 封装** 或 **axios** | 统一 baseURL、携带 Token、处理 401 跳转登录 |
| 样式     | **Tailwind CSS**（本地构建） | 去掉 CDN，用 `tailwindcss` 本地编译，便于定制与打包优化 |
| 表单     | **React Hook Form**（可选） | 管理后台表单多，可减少重渲染 |
| 表格/UI  | **Ant Design** 或 **shadcn/ui** | 管理后台列表、筛选、分页、模态框；若要保持轻量可仅用 Tailwind + 少量组件 |
| 提示     | **react-hot-toast** 或 **sonner** | 替代 alert，统一成功/错误提示 |

**大模型配置在前端的体现**：设置页（或管理员专属页）提供「当前使用的模型」选择（千问 / DeepSeek）、模型名称下拉或输入；API Key 不在前端出现，由管理员在后端或后台配置。

### 3.3 后端

| 类别     | 建议技术 | 说明 |
|----------|----------|------|
| 运行环境 | **Node.js 20+** | 与现有团队技能一致 |
| 框架     | **Express** 或 **Fastify** | 简单、生态成熟；Fastify 性能更好 |
| 语言     | **TypeScript** | 与前端类型可共享（如 Scenario、MediationSkill） |
| 鉴权     | **JWT**（Access Token + 可选 Refresh Token） | 登录后签发；接口除登录、注册外均校验 Token |
| 大模型   | **千问 / DeepSeek 官方 SDK 或 fetch** | 根据「提供商+模型」路由到对应 API；Key 从环境变量或管理配置表读取 |
| 校验     | **zod** 或 **joi** | 请求体校验（登录、用户 CRUD、案例/技巧 CRUD、模型配置） |

**API 设计要点**：

- `POST /api/auth/login`、可选 `POST /api/auth/refresh`
- `GET/POST/PUT/DELETE /api/users`（管理员）、`GET /api/users/me`
- `GET/POST/PUT/DELETE /api/scenarios`（案例）
- `GET/POST/PUT/DELETE /api/skills`（技巧手册）
- `GET/PUT /api/settings/llm`（模型配置，仅管理员或单独权限）
- `POST /api/llm/chat`（代理：body 含 provider、model、messages 等）
- `POST /api/llm/evaluate`（评估代理，同上）

### 3.4 数据库

| 类别     | 建议技术 | 说明 |
|----------|----------|------|
| 数据库   | **PostgreSQL** 或 **SQLite** | 开发/小规模可用 SQLite；正式环境推荐 PostgreSQL |
| ORM      | **Prisma** 或 **Drizzle** | 类型安全、迁移方便；与 TS 后端配合好 |

**核心表建议**：

- **users**：id, name, department, email/phone, role, password_hash, status, created_at, updated_at
- **scenarios**：id, title, category, description, difficulty, dispute_point, party_a, party_b (JSON), sort_order, enabled, created_at, updated_at
- **skills**：id, name, category, description, how_to_use, phrasings (JSON), pitfalls (JSON), enabled, created_at, updated_at
- **llm_config**（可选）：id, provider, model_name, api_key_encrypted, base_url, is_active, updated_at
- **sessions**（可选）：id, user_id, scenario_id, messages_snapshot (JSON), assessment_result (JSON), created_at — 用于「我的练习记录」

### 3.5 部署与运维

- **前端**：`npm run build` 生成静态资源，可部署到 Nginx / 对象存储 + CDN
- **后端**：Node 进程（PM2 或 Docker），Nginx 反向代理 `/api` 和 `/api/llm`
- **环境变量**：后端至少包含数据库 URL、JWT 密钥、默认或首选的 LLM API Key（若从库表读取则可减少敏感项）
- **可选**：Docker Compose 一键起前端 + 后端 + 数据库，便于内网部署

---

## 四、千问与 DeepSeek 对接要点

- **千问（通义）**：开放平台 API，兼容 OpenAI 风格（如 `https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions`），可统一用「OpenAI 兼容」的 HTTP 调用封装。
- **DeepSeek**：同样提供 OpenAI 兼容接口，例如 `https://api.deepseek.com/v1/chat/completions`。
- **后端**：抽象一层 `LLMProvider`，根据 `provider` 选择 baseURL 和 Key，请求体统一为 messages + model，返回统一解析为 `{ reply, coachTip, recommendedSkillName, moodA, moodB }` 或评估结构，便于前端无感切换。

---

## 五、实施阶段建议

| 阶段 | 内容 | 产出 |
|------|------|------|
| **Phase 1** | 后端骨架 + 鉴权 + 大模型代理（千问 + DeepSeek）+ 前端模型选择与 API 迁移 | 去掉 Gemini，前端可选千问/DeepSeek，Key 存后端 |
| **Phase 2** | 数据库 + 用户管理（CRUD）+ 登录/登出 + 前端路由与权限 | 员工/管理员账号、登录、基础权限 |
| **Phase 3** | 案例与技巧的 CRUD 接口 + 管理后台（案例列表/编辑、技巧列表/编辑） | 案例与技巧从数据库读取，后台可维护 |
| **Phase 4** | 此前优化落地：组件拆分、错误与 Toast、长对话策略、README、无障碍 | 体验与可维护性收尾 |

可按阶段交付：先完成 Phase 1 再做了 Phase 2，再上管理后台与数据持久化。

---

## 六、文档与仓库建议

- **README.md**：项目简介、功能列表、本地运行（前端 + 后端）、环境变量说明（含后端 JWT、DB、LLM Key）、构建与部署要点
- **docs/API.md**：后端接口列表、请求/响应示例（可后续用 OpenAPI 生成）
- **.env.example**：列出 `DATABASE_URL`、`JWT_SECRET`、`QWEN_API_KEY`、`DEEPSEEK_API_KEY` 等，便于团队与部署

---

以上规划可直接作为开发与评审依据；若需要，我可以从 Phase 1（后端骨架 + 千问/DeepSeek 代理 + 前端模型配置与调用迁移）开始给出具体目录与代码示例。
