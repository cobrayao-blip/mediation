# 在腾讯云服务器上执行 — 部署清单

我无法直接登录你的服务器，请你在**腾讯云服务器**上按下面步骤操作（复制粘贴即可）。服务器 IP：**122.51.67.38**，域名：**px.ibizsoft.cn**。

---

## 第一步：登录服务器

用 SSH 或腾讯云网页终端登录，例如：

```bash
ssh root@122.51.67.38
```

（或使用你的用户名替代 `root`。）

---

## 第二步：安装 Docker（若未安装）

若已安装可跳过。执行：

```bash
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
sudo systemctl start docker
sudo systemctl enable docker
docker --version
docker compose version
```

---

## 第三步：克隆项目并进入目录

```bash
sudo rm -rf /opt/mediation
sudo git clone https://github.com/cobrayao-blip/mediation.git /opt/mediation
cd /opt/mediation
```

---

## 第四步：配置 .env（必做）

```bash
sudo cp .env.example .env
sudo chown $(whoami):$(whoami) .env
nano .env
```

在 nano 中修改至少以下三项（强密码/随机字符串）：

- `POSTGRES_PASSWORD=你的数据库密码`
- `JWT_SECRET=任意一长串随机字符`
- `ADMIN_DEFAULT_PASSWORD=管理员初始密码`（**生产环境必填**，否则服务不启动）

保存：`Ctrl+O` 回车，退出：`Ctrl+X`。

---

## 第五步：一键构建并启动

```bash
cd /opt/mediation
docker compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.port8080.yml up -d --build
```

等待约 10～15 分钟。完成后检查：

```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.port8080.yml ps
```

三个服务应为 **Up**。

---

## 第六步：配置 Nginx（px.ibizsoft.cn）

创建配置文件：

```bash
sudo tee /etc/nginx/conf.d/px.ibizsoft.cn.conf << 'EOF'
server {
    listen 80;
    server_name px.ibizsoft.cn;
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF
```

检查并重载 Nginx：

```bash
sudo nginx -t && sudo nginx -s reload
```

---

## 第七步：放行端口（若未放行）

腾讯云安全组需放行 **80**（和 443，若用 HTTPS）。在腾讯云控制台 → 安全组 → 入站规则添加 80。

---

## 第八步：浏览器访问

打开：**http://px.ibizsoft.cn**

- 默认管理员：**admin@mediation.local**
- 密码：你在 `.env` 里设置的 **ADMIN_DEFAULT_PASSWORD**

---

## 可选：用脚本一键执行（第三步～第五步）

若已安装 Git 和 Docker，可把项目里的部署脚本上传到服务器后执行：

```bash
# 在服务器上（先有脚本时）
chmod +x deploy-on-server.sh
sudo ./deploy-on-server.sh
```

脚本会克隆仓库到 `/opt/mediation`、生成 `.env`、并执行 Docker 构建与启动。**你仍需手动编辑 `.env` 和配置 Nginx**（第四步、第六步）。

---

完整说明见：`/opt/mediation/docs/网站上线部署手册.md`。
